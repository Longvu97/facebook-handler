name: Facebook handler Deployment

on:
  push:
    branches:
      - main
      - release
  workflow_dispatch:
    inputs:
      environment:
        description: Target environment
        required: true
        default: dev
        type: choice
        options:
          - dev
          - prod
      extra-params:
        description: Additional parameter overrides (space separated)
        required: false
        default: ""

env:
  STACK_NAME: social-doors-facebook-handler
  DEPLOY_BUCKET: social-doors-sam-deployment

jobs:
  deploy-dev:
    name: Deploy (dev)
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    runs-on: ubuntu-latest
    environment: dev
    defaults:
      run:
        working-directory: cloudformation
    env:
      ENV: dev
      EXTRA_PARAMS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs['extra-params'] || '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - uses: aws-actions/setup-sam@v2
      - name: Build, package and deploy
        run: |
          echo "$ENV"
          sam build --template template.yaml
          sam package --output-template-file template.packaged.yaml --s3-bucket "$DEPLOY_BUCKET"
          sam deploy --no-fail-on-empty-changeset --template-file template.packaged.yaml --stack-name "${STACK_NAME}-${ENV}" --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --parameter-overrides "Env=${ENV}" ${EXTRA_PARAMS}

  deploy-prod:
    name: Deploy (prod)
    if: github.ref == 'refs/heads/release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    runs-on: ubuntu-latest
    environment: prod
    defaults:
      run:
        working-directory: cloudformation
    env:
      ENV: prod
      EXTRA_PARAMS: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs['extra-params'] || '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      - uses: aws-actions/setup-sam@v2
      - name: Build, package and deploy
        run: |
          echo "$ENV"
          sam build --template template.yaml
          sam package --output-template-file template.packaged.yaml --s3-bucket "$DEPLOY_BUCKET"
          sam deploy --no-fail-on-empty-changeset --template-file template.packaged.yaml --stack-name "${STACK_NAME}-${ENV}" --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM --parameter-overrides "Env=${ENV}" ${EXTRA_PARAMS}
